#!/usr/bin/env bash

command_help "configure polybar for this machine" $@
command_require ip

function ask_affirmative
{
    echo -n "$@ [default = n]: "
    read answer
    answer=$(echo "${answer}" | tr '[:upper:]' '[:lower:]')
    case ${answer} in
        y|yes|true)
            return 0
        ;;
    esac
    return -1
}

function ask
{
    label=$1
    echo -n "$2 [default = ${3:-''}]: "
    read $label
}

declare -a modules_right
declare -a modules_left
declare -a modules_center

modules_left+=(i3)

# iterate through interfaces and ask_affirmative which ones should be monitored
interfaces=($(netstat -i | tail -n+3 | awk '{print $1}'))
declare -a to_monitor
for interface in ${interfaces[@]}; do
    if ask_affirmative "Do you want to monitor interface: ${interface}?"; then
        to_monitor+=(${interface})
    fi
done

echo ${to_monitor[@]}

declare -A timezones
timezones["eastern"]="EST5EDT"
timezones["central"]="CST6CDT"

declare -a timezones_to_show=()
for tz in ${!timezones[@]}; do
    if ask_affirmative "Do you want to see $tz timezone?"; then
        module_name="${tz}_time"
        module_tz="${timzones[${tz}]}"
        echo ${module_tz}
        ask module_label "What do you want to label it?"
        $XDG_CONFIG_HOME/polybar/templates/time ${module_name} ${module_label} ${tz} > $XDG_CONFIG_HOME/polybar/modules/${module_name}
        modules_right+=(${module_name})
    fi
done

#if hash pactl; then
    #for sink in ($(pactl list sinks | grep "Name:"); do
        #if ask_affirmative "Do you want to monitor ${sink}?"; then
        #fi
    #done
#fi

if ask_affirmative "Is this a laptop?"; then
    modules_right+=("battery")
fi

if ask_affirmative "Want a power button?"; then
    modules_right+=("powermenu")
fi

if [ -f $XDG_CONFIG_HOME/polybar/config ]; then
    mv $XDG_CONFIG_HOME/polybar/config $XDG_CONFIG_HOME/polybar/config.bak.$(date +%Y%m%d%H%M%S)
fi

cat <<-EOF > ${XDG_CONFIG_HOME}/polybar/config
	; generated by 'config custom polybar-config'
	; $(date +%Y%m%d:%H%M%S)

	[settings]
	screenchange-reload = true
	dpi = \${local.dpi}

	[global/wm]
	margin-top = 5
	margin-bottom = 5

	include-file \$XDG_CONFIG_HOME/polybar/include-modules.cfg
	modules-left = ${modules_left[@]}
	modules-center = ${modules_center[@]}
	modules-right = ${modules_right[@]}
	
EOF

declare -a modules
modules+=(${modules_left[@]})
modules+=(${modules_center[@]})
modules+=(${modules_right[@]})

for module in ${modules[@]}; do
    echo "include-file \$XDG_CONFIG_HOME/polybar/modules/${module}" >> ${XDG_CONFIG_HOME}/polybar/config
done

